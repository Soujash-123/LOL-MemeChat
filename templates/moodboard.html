<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Text Editor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Import fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');

        :root {
            --primary-color: #60a5fa;
            --secondary-color: #e2e8f0;
            --background-color: #0f172a;
            --navbar-color: rgba(15, 23, 42, 0.95);
            --font-family: 'Inter';
        }

        body {
            font-family: var(--font-family), sans-serif;
            background: var(--background-color);
            color: var(--secondary-color);
        }

        .glass-effect {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vertical-nav {
            width: 240px;
            height: 100vh;
            position: fixed;
            left: -240px;
            top: 0;
            background: var(--navbar-color);
            backdrop-filter: blur(10px);
            z-index: 50;
            transition: left 0.3s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vertical-nav.open {
            left: 0;
        }

        .burger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 60;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            background: var(--navbar-color);
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .burger-menu span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--secondary-color);
            transition: all 0.3s ease;
        }

        .burger-menu.open span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .burger-menu.open span:nth-child(2) {
            opacity: 0;
        }

        .burger-menu.open span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--secondary-color);
        }

        .nav-link:hover {
            color: var(--primary-color);
            background: rgba(96, 165, 250, 0.1);
        }

        .nav-link.active {
            color: var(--primary-color);
            background: rgba(96, 165, 250, 0.1);
            border-right: 3px solid var(--primary-color);
        }

        .main-content {
            margin-left: 0;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            padding: 2rem;
            padding-top: 6rem;
            background: radial-gradient(circle at center, rgba(96, 165, 250, 0.1), transparent);
        }

        .theme-button {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-button:hover {
            transform: rotate(30deg);
        }

        .theme-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .theme-modal.active {
            display: flex;
        }

        .theme-content {
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
        }

        @media (min-width: 768px) {
            .vertical-nav {
                left: 0;
            }

            .burger-menu {
                display: none;
            }

            .main-content {
                margin-left: 240px;
            }

            .theme-button {
                right: 40px;
            }
        }

        .gradient-button {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            transition: all 0.3s ease;
        }

        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(96, 165, 250, 0.3);
        }

        textarea {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.95);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            background-color: rgba(30, 41, 59, 0.8);
            border-radius: 6px;
        }

        .control-group {
            margin-right: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #3367d6;
        }

        .editor-area {
            position: relative;
            border: 2px dashed var(--primary-color);
            min-height: 400px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        #imageCanvas {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        .text-box {
            position: absolute;
            min-width: 50px;
            min-height: 20px;
            padding: 5px;
            border: 1px dashed var(--primary-color);
            cursor: move;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .text-box:focus {
            outline: none;
            border: 1px solid var(--primary-color);
        }

        .instructions {
            background-color: rgba(232, 245, 233, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .instructions ul {
            margin-bottom: 0;
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="burger-menu">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <nav class="vertical-nav">
        <div class="py-6 px-4">
            <h1 class="text-2xl font-bold text-center">
                L<span style="color: var(--primary-color)">‚ù§</span>L
            </h1>
        </div>
        
        <div class="space-y-2">
            <a href="/feed" class="nav-link">
                <i class="fas fa-compass"></i>
                <span>Explore</span>
            </a>
            <a href="/dashboard" class="nav-link">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/chat" class="nav-link">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </a>
            <a href="/create" class="nav-link active">
                <i class="fas fa-plus"></i>
                <span>Create</span>
            </a>
            <a href="/list_connect" class="nav-link">
                <i class="fas fa-users"></i>
                <span>Matches</span>
            </a>
            <a href="/music-feed" class="nav-link">
                <i class="fas fa-headphones"></i>
                <span>My Music</span>
            </a>
            <a href="#" class="nav-link" onclick="navigateToProfile(event)">
                <i class="fas fa-user"></i><span>Profile</span>
            </a>
            <a href="#" onclick="logout()" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <h1>Image Text Editor</h1>
            
            <div class="instructions">
                <h3>How to Use:</h3>
                <ul>
                    <li>Upload an image using the button below</li>
                    <li>Add text boxes and customize them using the controls</li>
                    <li>Drag text boxes to position them anywhere on the image</li>
                    <li>When finished, download your creation</li>
                </ul>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label for="imageUpload">Upload Image:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                
                <div class="control-group">
                    <label for="addTextBtn">Add Text:</label>
                    <button id="addTextBtn">Add Text Box</button>
                </div>
                
                <div class="control-group">
                    <label for="fontFamily">Font Family:</label>
                    <select id="fontFamily">
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="Impact, fantasy">Impact</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="fontSize">Font Size:</label>
                    <input type="number" id="fontSize" min="8" max="72" value="16">
                </div>
                
                <div class="control-group">
                    <label for="fontColor">Font Color:</label>
                    <input type="color" id="fontColor" value="#000000">
                </div>
                
                <div class="control-group">
                    <label for="fontBold">Bold:</label>
                    <input type="checkbox" id="fontBold">
                </div>
                
                <div class="control-group">
                    <label for="fontItalic">Italic:</label>
                    <input type="checkbox" id="fontItalic">
                </div>
                
                <div class="control-group">
                    <label for="downloadBtn">Save:</label>
                    <button id="downloadBtn">Download Image</button>
                </div>
            </div>
            
            <div id="editorArea" class="editor-area">
                <canvas id="imageCanvas"></canvas>
            </div>
        </div>
    </main>

    <button class="theme-button">
        <i class="fas fa-paint-brush"></i>
    </button>

    <!-- Theme Modal -->
    <div class="theme-modal">
        <div class="theme-content glass-effect">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Customize Theme</h3>
                <button class="close-theme text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block mb-2">Primary Color</label>
                    <input type="color" id="primary-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Secondary Color</label>
                    <input type="color" id="secondary-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Background Color</label>
                    <input type="color" id="background-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Navbar Color</label>
                    <input type="color" id="navbar-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Font Family</label>
                    <select id="font-family" class="w-full p-2 rounded bg-gray-800 text-white">
                        <optgroup label="Sans Serif">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Lato">Lato</option>
                            <option value="Montserrat">Montserrat</option>
                        </optgroup>
                        <optgroup label="Serif">
                            <option value="Playfair Display">Playfair Display</option>
                        </optgroup>
                        <optgroup label="Cursive">
                            <option value="Dancing Script">Dancing Script</option>
                            <option value="Pacifico">Pacifico</option>
                            <option value="Great Vibes">Great Vibes</option>
                        </optgroup>
                    </select>
                </div>
                <button class="w-full py-2 px-4 gradient-button text-white rounded" id="reset-theme">
                    Reset to Default
                </button>
            </div>
        </div>
    </div>

    <script>
        async function navigateToProfile(event) {
            event.preventDefault();
            try {
                const response = await fetch('/user/profile');
                if (!response.ok) throw new Error('Failed to fetch profile');
                const data = await response.json();
                window.location.href = `/${data.username}`;
            } catch (error) {
                console.error('Error navigating to profile:', error);
            }
        }

        const themeKeys = {
            primaryColor: '--primary-color',
            secondaryColor: '--secondary-color',
            backgroundColor: '--background-color',
            navbarColor: '--navbar-color',
            fontFamily: '--font-family',
        };

        function initializeTheme() {
            Object.keys(themeKeys).forEach(key => {
                const savedValue = localStorage.getItem(key);
                if (savedValue) {
                    document.documentElement.style.setProperty(themeKeys[key], savedValue);
                    const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) {
                        input.value = savedValue;
                    }
                }
            });
        }

        function setupThemeListeners() {
            document.querySelector('.theme-button').addEventListener('click', () => {
                document.querySelector('.theme-modal').classList.add('active');
            });

            document.querySelector('.close-theme').addEventListener('click', () => {
                document.querySelector('.theme-modal').classList.remove('active');
            });

            document.querySelector('.theme-modal').addEventListener('click', (e) => {
                if (e.target === document.querySelector('.theme-modal')) {
                    document.querySelector('.theme-modal').classList.remove('active');
                }
            });

            Object.keys(themeKeys).forEach(key => {
                const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input) {
                    input.addEventListener('input', (e) => {
                        document.documentElement.style.setProperty(themeKeys[key], e.target.value);
                        localStorage.setItem(key, e.target.value);
                    });
                }
            });

            document.getElementById('reset-theme').addEventListener('click', () => {
                const defaults = {
                    primaryColor: '#60a5fa',
                    secondaryColor: '#e2e8f0',
                    backgroundColor: '#0f172a',
                    navbarColor: 'rgba(15, 23, 42, 0.95)',
                    fontFamily: 'Inter'
                };
                
                Object.entries(defaults).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(themeKeys[key], value);
                    localStorage.setItem(key, value);
                    
                    const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) {
                        if (input.type === 'color') {
                            if (value.startsWith('rgba')) {
                                const rgb = value.match(/\d+/g).slice(0, 3);
                                const hex = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                                input.value = hex;
                            } else {
                                input.value = value;
                            }
                        } else {
                            input.value = value;
                        }
                    }
                });
            });
        }

        // Navigation functionality 
        const burgerMenu = document.querySelector('.burger-menu');
        const nav = document.querySelector('.vertical-nav');

        burgerMenu.addEventListener('click', () => {
            burgerMenu.classList.toggle('open');
            nav.classList.toggle('open');
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                burgerMenu.classList.remove('open');
                nav.classList.remove('open');
            }
        });

        async function logout() {
            try {
                const response = await fetch('/logout');
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    alert('Failed to logout');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Failed to logout');
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            setupThemeListeners();
        });

        // Image Text Editor Script
        document.addEventListener('DOMContentLoaded', function() {
            const imageUpload = document.getElementById('imageUpload');
            const imageCanvas = document.getElementById('imageCanvas');
            const editorArea = document.getElementById('editorArea');
            const addTextBtn = document.getElementById('addTextBtn');
            const fontFamily = document.getElementById('fontFamily');
            const fontSize = document.getElementById('fontSize');
            const fontColor = document.getElementById('fontColor');
            const fontBold = document.getElementById('fontBold');
            const fontItalic = document.getElementById('fontItalic');
            const downloadBtn = document.getElementById('downloadBtn');
            
            let selectedTextBox = null;
            let uploadedImage = null;
            
            // Handle image upload
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        uploadedImage = new Image();
                        uploadedImage.onload = function() {
                            // Clear existing text boxes
                            document.querySelectorAll('.text-box').forEach(box => box.remove());
                            
                            // Set canvas dimensions
                            const maxWidth = editorArea.clientWidth;
                            let width = uploadedImage.width;
                            let height = uploadedImage.height;
                            
                            if (width > maxWidth) {
                                const ratio = maxWidth / width;
                                width = maxWidth;
                                height = height * ratio;
                            }
                            
                            imageCanvas.width = width;
                            imageCanvas.height = height;
                            
                            const ctx = imageCanvas.getContext('2d');
                            ctx.drawImage(uploadedImage, 0, 0, width, height);
                        };
                        uploadedImage.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Add text box
            addTextBtn.addEventListener('click', function() {
                if (!uploadedImage) {
                    alert('Please upload an image first');
                    return;
                }
                
                const textBox = document.createElement('div');
                textBox.className = 'text-box';
                textBox.contentEditable = true;
                textBox.innerHTML = 'Enter text here';
                textBox.style.left = '50px';
                textBox.style.top = '50px';
                
                // Apply current font settings
                applyFontSettings(textBox);
                
                editorArea.appendChild(textBox);
                
                // Make the text box draggable
                makeElementDraggable(textBox);
                
                // Select this text box
                textBox.addEventListener('click', function() {
                    selectTextBox(textBox);
                });
                
                // Auto-select the newly created text box
                selectTextBox(textBox);
            });
            
            // Apply font settings to selected text box
            function applyFontSettings(textBox) {
                if (!textBox) return;
                
                textBox.style.fontFamily = fontFamily.value;
                textBox.style.fontSize = fontSize.value + 'px';
                textBox.style.color = fontColor.value;
                textBox.style.fontWeight = fontBold.checked ? 'bold' : 'normal';
                textBox.style.fontStyle = fontItalic.checked ? 'italic' : 'normal';
            }
            
            // Select text box and update controls
            function selectTextBox(textBox) {
                // Deselect any previously selected text box
                if (selectedTextBox) {
                    selectedTextBox.style.border = '1px dashed var(--primary-color)';
                }
                
                selectedTextBox = textBox;
                selectedTextBox.style.border = '2px solid var(--primary-color)';
                
                // Focus on the text box
                selectedTextBox.focus();
            }
            
            // Make element draggable
            function makeElementDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                element.onmousedown = dragMouseDown;
                
                function dragMouseDown(e) {
                    e.preventDefault();
                    // Get the mouse cursor position at startup
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // Call a function whenever the cursor moves
                    document.onmousemove = elementDrag;
                    
                    // Select this text box
                    selectTextBox(element);
                }
                
                function elementDrag(e) {
                    e.preventDefault();
                    // Calculate the new cursor position
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // Set the element's new position
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }
                
                function closeDragElement() {
                    // Stop moving when mouse button is released
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
            
            // Update font settings when controls change
            fontFamily.addEventListener('change', () => applyFontSettings(selectedTextBox));
            fontSize.addEventListener('change', () => applyFontSettings(selectedTextBox));
            fontColor.addEventListener('input', () => applyFontSettings(selectedTextBox));
            fontBold.addEventListener('change', () => applyFontSettings(selectedTextBox));
            fontItalic.addEventListener('change', () => applyFontSettings(selectedTextBox));
            
            // Download the composite image
            downloadBtn.addEventListener('click', function() {
                if (!uploadedImage) {
                    alert('Please upload an image first');
                    return;
                }
                
                // Create a temporary canvas to draw everything
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = imageCanvas.width;
                tempCanvas.height = imageCanvas.height;
                const ctx = tempCanvas.getContext('2d');
                
                // Draw the image
                ctx.drawImage(imageCanvas, 0, 0);
                
                // Draw all text boxes
                document.querySelectorAll('.text-box').forEach(box => {
                    const boxRect = box.getBoundingClientRect();
                    const canvasRect = imageCanvas.getBoundingClientRect();
                    
                    // Calculate position relative to canvas
                    const x = boxRect.left - canvasRect.left;
                    const y = boxRect.top - canvasRect.top;
                    
                    // Apply text styles
                    ctx.font = `${box.style.fontStyle} ${box.style.fontWeight} ${box.style.fontSize} ${box.style.fontFamily}`;
                    ctx.fillStyle = box.style.color;
                    
                    // Draw text
                    ctx.fillText(box.innerText, x, y + parseInt(box.style.fontSize));
                });
                
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.download = 'edited-image.png';
                downloadLink.href = tempCanvas.toDataURL('image/png');
                downloadLink.click();
            });
        });
    </script>
</body>
</html>