<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Import fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');

        :root {
            --primary-color: #60a5fa;
            --secondary-color: #e2e8f0;
            --background-color: #0f172a;
            --navbar-color: rgba(15, 23, 42, 0.95);
            --font-family: 'Inter';
        }

        body {
            font-family: var(--font-family), sans-serif;
            background: var(--background-color);
            color: var(--secondary-color);
            overflow-x: hidden;
        }

        .glass-effect {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .theme-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .theme-modal.active {
            display: flex;
        }

        .theme-content {
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
        }

        .theme-button {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-button:hover {
            transform: rotate(30deg);
        }

        .vertical-nav {
            width: 240px;
            height: 100vh;
            position: fixed;
            left: -240px;
            top: 0;
            background: var(--navbar-color);
            backdrop-filter: blur(10px);
            z-index: 50;
            transition: left 0.3s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vertical-nav.open {
            left: 0;
        }

        .burger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 60;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            background: var(--navbar-color);
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .burger-menu span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--secondary-color);
            transition: all 0.3s ease;
        }

        .burger-menu.open span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .burger-menu.open span:nth-child(2) {
            opacity: 0;
        }

        .burger-menu.open span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--secondary-color);
        }

        .nav-link:hover {
            color: var(--primary-color);
            background: rgba(96, 165, 250, 0.1);
        }

        .nav-link.active {
            color: var(--primary-color);
            background: rgba(96, 165, 250, 0.1);
            border-right: 3px solid var(--primary-color);
        }

        .main-content {
            margin-left: 0;
            min-height: 100vh;
            display: flex;
            transition: margin-left 0.3s ease;
            background: radial-gradient(circle at center, rgba(96, 165, 250, 0.1), transparent);
        }

        .editor-panel {
            width: 300px;
            background-color: rgba(15, 23, 42, 0.9);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 20px;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .template-item {
            position: relative;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .template-item:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .template-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }

        .template-item .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .template-item:hover .overlay {
            opacity: 1;
        }

        .playground {
            flex: 1;
            height: 100vh;
            padding: 20px;
            position: relative;
            overflow: auto;
        }

        .editor-area {
            position: relative;
            min-height: 70vh;
            margin: 0 auto;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
            background-color: rgba(15, 23, 42, 0.3);
        }

        #imageCanvas {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        .text-box {
            position: absolute;
            min-width: 50px;
            min-height: 20px;
            padding: 5px;
            border: 1px dashed var(--primary-color);
            cursor: move;
            background-color: rgba(255, 255, 255, 0.7);
            color: #000;
            border-radius: 4px;
        }

        .text-box:focus {
            outline: none;
            border: 1px solid var(--primary-color);
        }

        .shape {
            position: absolute;
            cursor: move;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .rectangle {
            width: 100px;
            height: 60px;
        }

        .circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }

        .triangle {
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 86px solid rgba(255, 255, 255, 0.7);
            background-color: transparent;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .component-section {
            margin-bottom: 20px;
        }

        .component-title {
            font-weight: 600;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        .components-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .component-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .component-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .component-item i {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .editor-controls {
            margin-top: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--secondary-color);
        }

        .control-options {
            display: flex;
            gap: 10px;
        }

        .control-options label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4a86db;
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .game-frame {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        @media (min-width: 768px) {
            .vertical-nav {
                left: 0;
            }

            .burger-menu {
                display: none;
            }

            .main-content {
                margin-left: 240px;
            }
        }

        /* Add these new responsive styles */
        .action-buttons .btn {
            transition: all 0.3s ease;
        }

        .action-buttons .btn i {
            margin-right: 8px;
        }

        /* Mobile bottom toolbar */
        .mobile-editor-toolbar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--navbar-color);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .mobile-editor-toolbar .tools-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            justify-items: center;
        }

        .tool-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            color: var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tool-button.active {
            background: var(--primary-color);
            color: white;
        }

        @media (max-width: 1024px) {
            .action-buttons .btn span {
                display: none;
            }

            .action-buttons .btn {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .action-buttons .btn i {
                margin: 0;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .editor-panel {
                display: none;
            }

            .mobile-editor-toolbar {
                display: block;
            }

            .playground {
                padding-bottom: 80px;
            }

            .action-buttons {
                position: fixed;
                top: auto;
                bottom: 80px;
                right: 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                z-index: 99;
            }

            .action-buttons .btn {
                width: 45px;
                height: 45px;
                margin: 0;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .action-buttons .btn i {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="burger-menu">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="nav-overlay"></div>

    <nav class="vertical-nav">
        <div class="py-6 px-4">
            <h1 class="text-2xl font-bold text-center">
                L<span class="text-blue-500">❤</span>L
            </h1>
        </div>
        
        <div class="space-y-2">
            <a href="/feed" class="nav-link">
                <i class="fas fa-compass"></i>
                <span>Explore</span>
            </a>
            <a href="/dashboard" class="nav-link">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/chat" class="nav-link">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </a>
            <a href="/create" class="nav-link">
                <i class="fas fa-plus"></i>
                <span>Create</span>
            </a>
            <a href="/moodboard" class="nav-link active">
                <i class="fas fa-palette"></i>
                <span>Moodboard</span>
            </a>
            <a href="/list_connect" class="nav-link">
                <i class="fas fa-users"></i>
                <span>Matches</span>
            </a>
            <a href="/game" class="nav-link">
                <i class="fas fa-gamepad"></i>
                <span>Chill Zone</span>
            </a>
            <a href="/music-feed" class="nav-link">
                <i class="fas fa-headphones"></i>
                <span>My Music</span>
            </a>
            <a href="#" class="nav-link" onclick="navigateToProfile(event)">
                <i class="fas fa-user"></i><span>Profile</span>
            </a>
            <a href="#" onclick="logout()" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <!-- Editor Panel (Left Side) -->
        <div class="editor-panel">
            <h2 class="section-title">Editor Tools</h2>
            
            <!-- Upload Section -->
            <div class="component-section">
                <div class="component-title">Upload</div>
                <div class="control-group">
                    <label for="imageUpload">Upload Image:</label>
                    <input type="file" id="imageUpload" accept="image/*" class="btn btn-secondary w-full">
                </div>
            </div>
            
            <!-- Templates Section -->
            <div class="component-section">
                <div class="component-title">My Templates</div>
                <div id="templates-container" class="templates-grid">
                    <!-- Templates will be loaded here from localStorage -->
                    <div class="empty-templates text-center py-4 text-gray-400 italic">
                        No templates yet. Upload an image to get started.
                    </div>
                </div>
            </div>
            
            <!-- Components Section -->
            <div class="component-section">
                <div class="component-title">Components</div>
                <div class="components-grid">
                    <div class="component-item" onclick="addShape('rectangle')">
                        <i class="fas fa-square"></i>
                        <span>Rectangle</span>
                    </div>
                    <div class="component-item" onclick="addShape('circle')">
                        <i class="fas fa-circle"></i>
                        <span>Circle</span>
                    </div>
                    <div class="component-item" onclick="addShape('triangle')">
                        <i class="fas fa-play"></i>
                        <span>Triangle</span>
                    </div>
                    <div class="component-item" onclick="addTextBox()">
                        <i class="fas fa-font"></i>
                        <span>Text</span>
                    </div>
                    <div class="component-item" onclick="addImage()">
                        <i class="fas fa-image"></i>
                        <span>Image</span>
                    </div>
                    <div class="component-item" onclick="addSticker()">
                        <i class="fas fa-smile"></i>
                        <span>Sticker</span>
                    </div>
                </div>
            </div>
            
            <!-- Text Formatting -->
            <div class="component-section">
                <div class="component-title">Text Formatting</div>
                <div class="editor-controls">
                    <div class="control-group">
                        <label for="fontFamily">Font Family:</label>
                        <select id="fontFamily">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Impact, fantasy">Impact</option>
                            <option value="'Dancing Script', cursive">Dancing Script</option>
                            <option value="'Pacifico', cursive">Pacifico</option>
                            <option value="'Playfair Display', serif">Playfair Display</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="fontSize">Font Size:</label>
                        <input type="number" id="fontSize" min="8" max="72" value="16">
                    </div>
                    <div class="control-group">
                        <label for="fontColor">Font Color:</label>
                        <input type="color" id="fontColor" value="#000000">
                    </div>
                    <div class="control-group">
                        <div class="control-options">
                            <label>
                                <input type="checkbox" id="fontBold">
                                <span class="ml-2">Bold</span>
                            </label>
                            <label>
                                <input type="checkbox" id="fontItalic">
                                <span class="ml-2">Italic</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shape Formatting -->
            <div class="component-section">
                <div class="component-title">Shape Formatting</div>
                <div class="editor-controls">
                    <div class="control-group">
                        <label for="shapeColor">Color:</label>
                        <input type="color" id="shapeColor" value="#ffffff">
                    </div>
                    <div class="control-group">
                        <label for="shapeOpacity">Opacity:</label>
                        <input type="range" id="shapeOpacity" min="0" max="100" value="70">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Playground (Right Side) -->
        <div class="playground">
            <h1 class="text-2xl font-bold mb-6">Moodboard Creator</h1>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="clearBtn" class="btn btn-secondary">
                    <i class="fas fa-trash"></i>
                    <span>Clear</span>
                </button>
                <button id="saveBtn" class="btn btn-primary" onclick="saveMoodboard()">
                    <i class="fas fa-save"></i>
                    <span>Save</span>
                </button>
                <button id="downloadBtn" class="btn btn-primary">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </button>
                <button id="shareBtn" class="btn btn-primary" onclick="shareToFeed()">
                    <i class="fas fa-share-alt"></i>
                    <span>Share to Feed</span>
                </button>
                <button id="aiGenBtn" class="btn btn-primary" onclick="goToCreate()">
                    <i class="fas fa-magic"></i>
                    <span>Generate with AI</span>
                </button>
            </div>
            
            <!-- Editor Area -->
            <div id="editorArea" class="editor-area">
                <canvas id="imageCanvas"></canvas>
                <div id="layersContainer"></div>
            </div>
            
            <!-- Chill Zone Game Frame -->
            <div class="mt-8">
                <h2 class="section-title">Take a Break in Chill Zone</h2>
                <iframe src="/game" class="game-frame" title="Chill Zone"></iframe>
            </div>
        </div>
    </main>

    <!-- Add this new mobile editor toolbar -->
    <div class="mobile-editor-toolbar">
        <div class="tools-grid">
            <div class="tool-button" onclick="addTextBox()">
                <i class="fas fa-font"></i>
            </div>
            <div class="tool-button" onclick="addShape('rectangle')">
                <i class="fas fa-square"></i>
            </div>
            <div class="tool-button" onclick="addShape('circle')">
                <i class="fas fa-circle"></i>
            </div>
            <div class="tool-button" onclick="addShape('triangle')">
                <i class="fas fa-play"></i>
            </div>
            <div class="tool-button" onclick="addSticker()">
                <i class="fas fa-smile"></i>
            </div>
            <div class="tool-button" onclick="addImage()">
                <i class="fas fa-image"></i>
            </div>
        </div>
    </div>

    <button class="theme-button">
        <i class="fas fa-paint-brush"></i>
    </button>

    <!-- Theme Modal -->
    <div class="theme-modal">
        <div class="theme-content glass-effect">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Customize Theme</h3>
                <button class="close-theme text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block mb-2">Primary Color</label>
                    <input type="color" id="primary-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Secondary Color</label>
                    <input type="color" id="secondary-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Background Color</label>
                    <input type="color" id="background-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Navbar Color</label>
                    <input type="color" id="navbar-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Font Family</label>
                    <select id="font-family" class="w-full p-2 rounded bg-gray-800 text-white">
                        <optgroup label="Sans Serif">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Lato">Lato</option>
                            <option value="Montserrat">Montserrat</option>
                        </optgroup>
                        <optgroup label="Serif">
                            <option value="Playfair Display">Playfair Display</option>
                        </optgroup>
                        <optgroup label="Cursive">
                            <option value="Dancing Script">Dancing Script</option>
                            <option value="Pacifico">Pacifico</option>
                            <option value="Great Vibes">Great Vibes</option>
                        </optgroup>
                    </select>
                </div>
                <button class="w-full py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors" id="reset-theme">
                    Reset to Default
                </button>
            </div>
        </div>
    </div>

    <script>
        // Navigation functionality
const burgerMenu = document.querySelector('.burger-menu');
const nav = document.querySelector('.vertical-nav');
const overlay = document.querySelector('.nav-overlay');

burgerMenu.addEventListener('click', toggleNav);
overlay?.addEventListener('click', closeNav);

function toggleNav() {
    burgerMenu.classList.toggle('open');
    nav.classList.toggle('open');
    overlay?.classList.toggle('visible');
}

function closeNav() {
    burgerMenu.classList.remove('open');
    nav.classList.remove('open');
    overlay?.classList.remove('visible');
}

// Handle window resize
window.addEventListener('resize', () => {
    if (window.innerWidth >= 768) {
        closeNav();
    }
});

// Initialize theme
const themeKeys = {
    primaryColor: '--primary-color',
    secondaryColor: '--secondary-color',
    backgroundColor: '--background-color',
    navbarColor: '--navbar-color',
    fontFamily: '--font-family',
};

function initializeTheme() {
    Object.keys(themeKeys).forEach(key => {
        const savedValue = localStorage.getItem(key);
        if (savedValue) {
            document.documentElement.style.setProperty(themeKeys[key], savedValue);
            const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
            if (input) {
                input.value = savedValue;
            }
        }
    });
}

function setupThemeListeners() {
    document.querySelector('.theme-button').addEventListener('click', () => {
        document.querySelector('.theme-modal').classList.add('active');
    });

    document.querySelector('.close-theme').addEventListener('click', () => {
        document.querySelector('.theme-modal').classList.remove('active');
    });

    document.querySelector('.theme-modal').addEventListener('click', (e) => {
        if (e.target === document.querySelector('.theme-modal')) {
            document.querySelector('.theme-modal').classList.remove('active');
        }
    });

    Object.keys(themeKeys).forEach(key => {
        const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
        if (input) {
            input.addEventListener('input', (e) => {
                document.documentElement.style.setProperty(themeKeys[key], e.target.value);
                localStorage.setItem(key, e.target.value);
            });
        }
    });

    document.getElementById('reset-theme').addEventListener('click', () => {
        const defaults = {
            primaryColor: '#60a5fa',
            secondaryColor: '#e2e8f0',
            backgroundColor: '#0f172a',
            navbarColor: 'rgba(15, 23, 42, 0.95)',
            fontFamily: 'Inter'
        };
        
        Object.entries(defaults).forEach(([key, value]) => {
            document.documentElement.style.setProperty(themeKeys[key], value);
            localStorage.setItem(key, value);
            
            const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
            if (input) {
                if (input.type === 'color') {
                    if (value.startsWith('rgba')) {
                        const rgb = value.match(/\d+/g).slice(0, 3);
                        const hex = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                        input.value = hex;
                    } else {
                        input.value = value;
                    }
                } else {
                    input.value = value;
                }
            }
        });
    });
}

// Template Storage Management
function saveImageToTemplates(imageDataUrl, id) {
    let templates = getTemplates();
    const newTemplate = {
        id: id || Date.now(),
        imageUrl: imageDataUrl,
        created: new Date().toISOString()
    };
    
    templates.push(newTemplate);
    localStorage.setItem('moodboardTemplates', JSON.stringify(templates));
    renderTemplates();
}

function getTemplates() {
    const templates = localStorage.getItem('moodboardTemplates');
    return templates ? JSON.parse(templates) : [];
}

function renderTemplates() {
    const templates = getTemplates();
    const container = document.getElementById('templates-container');
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div class="empty-templates text-center py-4 text-gray-400 italic">
                No templates yet. Upload an image to get started.
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    templates.forEach(template => {
        const templateEl = document.createElement('div');
        templateEl.className = 'template-item';
        templateEl.innerHTML = `
            <img src="${template.imageUrl}" alt="Template">
            <div class="overlay">
                <button class="btn btn-primary btn-sm use-template">
                    <i class="fas fa-edit"></i> Use
                </button>
            </div>
        `;
        templateEl.querySelector('.use-template').addEventListener('click', (e) => {
            e.stopPropagation();
            loadImageToCanvas(template.imageUrl);
        });
        
        // Make the entire item clickable as well
        templateEl.addEventListener('click', () => {
            loadImageToCanvas(template.imageUrl);
        });
        
        container.appendChild(templateEl);
    });
}

// Image Text Editor Functionality
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const imageUpload = document.getElementById('imageUpload');
    const imageCanvas = document.getElementById('imageCanvas');
    const editorArea = document.getElementById('editorArea');
    const fontFamily = document.getElementById('fontFamily');
    const fontSize = document.getElementById('fontSize');
    const fontColor = document.getElementById('fontColor');
    const fontBold = document.getElementById('fontBold');
    const fontItalic = document.getElementById('fontItalic');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const shapeColor = document.getElementById('shapeColor');
    const shapeOpacity = document.getElementById('shapeOpacity');
    
    // Initialize canvas and state
    const ctx = imageCanvas.getContext('2d');
    let selectedElement = null;
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let canvasImage = null;
    
    // Initialize
    initializeTheme();
    setupThemeListeners();
    renderTemplates();
    
    // Expose functions to global scope so they can be called from HTML
    window.addTextBox = addTextBox;
    window.addShape = addShape;
    window.addImage = addImage;
    window.addSticker = addSticker;
    window.saveMoodboard = saveMoodboard;
    window.shareToFeed = shareToFeed;
    window.goToCreate = goToCreate;
    window.navigateToProfile = navigateToProfile;
    window.logout = logout;
    window.loadImageToCanvas = loadImageToCanvas;
    
    // Image Upload Handler
    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.match('image.*')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                loadImageToCanvas(imageUrl);
                saveImageToTemplates(imageUrl);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Load Image to Canvas
    function loadImageToCanvas(imageUrl) {
        const img = new Image();
        img.onload = function() {
            // Calculate dimensions while maintaining aspect ratio
            const maxWidth = editorArea.clientWidth - 40;
            const maxHeight = editorArea.clientHeight - 40;
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
            }
            
            if (height > maxHeight) {
                const ratio = maxHeight / height;
                height = maxHeight;
                width = width * ratio;
            }
            
            imageCanvas.width = width;
            imageCanvas.height = height;
            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            canvasImage = imageUrl;
        };
        img.src = imageUrl;
    }
    
    // Add Text Box
    function addTextBox() {
        const textBox = document.createElement('div');
        textBox.className = 'text-box';
        textBox.contentEditable = true;
        textBox.textContent = 'Edit me';
        textBox.style.left = '50%';
        textBox.style.top = '50%';
        textBox.style.transform = 'translate(-50%, -50%)';
        
        // Apply current text formatting
        updateTextFormatting(textBox);
        
        editorArea.appendChild(textBox);
        makeElementDraggable(textBox);
        
        // Focus on the new text box
        setTimeout(() => {
            textBox.focus();
            document.execCommand('selectAll', false, null);
        }, 10);
    }
    
    // Add Shape
    function addShape(type) {
        const shape = document.createElement('div');
        shape.className = `shape ${type}`;
        shape.dataset.type = type;
        
        // Apply current shape formatting
        const color = shapeColor.value;
        const opacity = shapeOpacity.value / 100;
        shape.style.backgroundColor = color;
        shape.style.opacity = opacity;
        
        shape.style.left = '50%';
        shape.style.top = '50%';
        shape.style.transform = 'translate(-50%, -50%)';
        
        editorArea.appendChild(shape);
        makeElementDraggable(shape);
    }
    
    // Add Image
    function addImage() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgElement = document.createElement('img');
                    imgElement.src = e.target.result;
                    imgElement.className = 'shape';
                    imgElement.style.width = '150px';
                    imgElement.style.height = 'auto';
                    imgElement.style.position = 'absolute';
                    imgElement.style.left = '50%';
                    imgElement.style.top = '50%';
                    imgElement.style.transform = 'translate(-50%, -50%)';
                    
                    editorArea.appendChild(imgElement);
                    makeElementDraggable(imgElement);
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    }
    
    // Add Sticker
    function addSticker() {
        const stickers = [
            '😀', '😍', '🥰', '😎', '🤩', '🔥', '💯', '❤️', '✨', '⭐',
            '🌟', '🎉', '🎊', '🎈', '🎁', '🎯', '🏆', '🥇', '👍', '👑'
        ];
        
        const stickerContainer = document.createElement('div');
        stickerContainer.className = 'shape sticker';
        stickerContainer.textContent = stickers[Math.floor(Math.random() * stickers.length)];
        stickerContainer.style.fontSize = '40px';
        stickerContainer.style.left = '50%';
        stickerContainer.style.top = '50%';
        stickerContainer.style.transform = 'translate(-50%, -50%)';
        
        editorArea.appendChild(stickerContainer);
        makeElementDraggable(stickerContainer);
    }
    
    // Element dragging functionality
    function makeElementDraggable(element) {
        element.addEventListener('mousedown', function(e) {
            // Don't start dragging if we're editing text
            if (e.target.isContentEditable && e.target === document.activeElement) {
                return;
            }
            
            // Select the element
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            selectedElement = element;
            selectedElement.classList.add('selected');
            
            // Update controls to match selected element
            if (element.classList.contains('text-box')) {
                updateControlsFromElement(element);
            } else if (element.classList.contains('shape')) {
                // Update shape controls
                if (element.style.backgroundColor) {
                    shapeColor.value = rgbToHex(element.style.backgroundColor);
                }
                if (element.style.opacity) {
                    shapeOpacity.value = parseFloat(element.style.opacity) * 100;
                }
            }
            
            // Start drag
            isDragging = true;
            const rect = element.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            
            e.preventDefault();
        });
    }
    
    document.addEventListener('mousemove', function(e) {
        if (isDragging && selectedElement) {
            const editorRect = editorArea.getBoundingClientRect();
            let newLeft = e.clientX - editorRect.left - dragOffsetX;
            let newTop = e.clientY - editorRect.top - dragOffsetY;
            
            // Constrain to editor area
            newLeft = Math.max(0, Math.min(newLeft, editorRect.width - selectedElement.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, editorRect.height - selectedElement.offsetHeight));
            
            selectedElement.style.left = newLeft + 'px';
            selectedElement.style.top = newTop + 'px';
            
            // Remove transform if it exists (from initial centering)
            selectedElement.style.transform = 'none';
        }
    });
    
    document.addEventListener('mouseup', function() {
        isDragging = false;
    });
    
    // Add keyboard shortcuts for deleting selected element
    document.addEventListener('keydown', function(e) {
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedElement) {
            // Only delete if not editing text
            if (!(selectedElement.isContentEditable && selectedElement === document.activeElement)) {
                selectedElement.remove();
                selectedElement = null;
            }
        }
    });
    
    // Update Text Formatting
    function updateTextFormatting(element) {
        if (!element) {
            if (selectedElement && selectedElement.classList.contains('text-box')) {
                element = selectedElement;
            } else {
                return;
            }
        }
        
        element.style.fontFamily = fontFamily.value;
        element.style.fontSize = fontSize.value + 'px';
        element.style.color = fontColor.value;
        element.style.fontWeight = fontBold.checked ? 'bold' : 'normal';
        element.style.fontStyle = fontItalic.checked ? 'italic' : 'normal';
    }
    
    // Update Controls From Element
    function updateControlsFromElement(element) {
        if (element.classList.contains('text-box')) {
            const style = window.getComputedStyle(element);
            fontFamily.value = style.fontFamily.split(',')[0].replace(/['"]/g, '');
            fontSize.value = parseInt(style.fontSize);
            fontColor.value = rgbToHex(style.color);
            fontBold.checked = style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 600;
            fontItalic.checked = style.fontStyle === 'italic';
        }
    }
    
    // RGB to Hex conversion helper
    function rgbToHex(rgb) {
        if (rgb.startsWith('rgb')) {
            const [r, g, b] = rgb.match(/\d+/g).map(Number);
            return '#' + ((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1);
        }
        return rgb;
    }
    
    // Text Formatting Controls Listeners
    fontFamily.addEventListener('change', updateTextFormatting);
    fontSize.addEventListener('input', updateTextFormatting);
    fontColor.addEventListener('input', updateTextFormatting);
    fontBold.addEventListener('change', updateTextFormatting);
    fontItalic.addEventListener('change', updateTextFormatting);
    
    // Shape Formatting Controls Listeners
    shapeColor.addEventListener('input', function() {
        if (selectedElement && selectedElement.classList.contains('shape')) {
            selectedElement.style.backgroundColor = shapeColor.value;
        }
    });
    
    shapeOpacity.addEventListener('input', function() {
        if (selectedElement && selectedElement.classList.contains('shape')) {
            selectedElement.style.opacity = shapeOpacity.value / 100;
        }
    });
    
    // Clear Button
    clearBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear the canvas? All unsaved work will be lost.')) {
            const layersContainer = document.getElementById('layersContainer');
            layersContainer.innerHTML = '';
            ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
            canvasImage = null;
            
            // Remove all text boxes and shapes
            const elements = editorArea.querySelectorAll('.text-box, .shape');
            elements.forEach(el => el.remove());
        }
    });
    
    // Download Button
    downloadBtn.addEventListener('click', function() {
        html2canvas(editorArea, {
            backgroundColor: null,
            useCORS: true,
            scale: 2
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'moodboard-' + new Date().getTime() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    });
    
    // Save Moodboard
    function saveMoodboard() {
        html2canvas(editorArea, {
            backgroundColor: null,
            useCORS: true,
            scale: 2
        }).then(canvas => {
            const moodboardImage = canvas.toDataURL('image/png');
            saveImageToTemplates(moodboardImage);
            alert('Moodboard saved to templates!');
        });
    }
    
    // Share to Feed
    function shareToFeed() {
        html2canvas(editorArea, {
            backgroundColor: null,
            useCORS: true,
            scale: 2
        }).then(canvas => {
            const moodboardImage = canvas.toDataURL('image/png');
            localStorage.setItem('sharedMoodboard', moodboardImage);
            alert('Your moodboard is ready to share! Redirecting to feed...');
            setTimeout(() => {
                window.location.href = '/feed?share=true';
            }, 1000);
        });
    }
    
    // Go to AI Creation
    function goToCreate() {
        window.location.href = '/create';
    }
    
    // Navigate to Profile 
    async function navigateToProfile(event) {
            event.preventDefault();
            try {
                const response = await fetch('/user/profile');
                if (!response.ok) throw new Error('Failed to fetch profile');
                const data = await response.json();
                window.location.href = `/${data.username}`;
            } catch (error) {
                console.error('Error navigating to profile:', error);
            }
        }
    
    // Logout Function
    async function logout() {
            try {
                const response = await fetch('/logout');
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    alert('Failed to logout');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Failed to logout');
            }
        }
    
    // Add Resizing Functionality for Elements
    function makeElementResizable(element) {
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        resizer.style.width = '10px';
        resizer.style.height = '10px';
        resizer.style.background = 'var(--primary-color)';
        resizer.style.position = 'absolute';
        resizer.style.right = '0';
        resizer.style.bottom = '0';
        resizer.style.cursor = 'nwse-resize';
        
        element.appendChild(resizer);
        
        let original_width = 0;
        let original_height = 0;
        let original_x = 0;
        let original_y = 0;
        let original_mouse_x = 0;
        let original_mouse_y = 0;
        
        resizer.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            original_width = parseFloat(getComputedStyle(element, null).getPropertyValue('width').replace('px', ''));
            original_height = parseFloat(getComputedStyle(element, null).getPropertyValue('height').replace('px', ''));
            original_x = element.getBoundingClientRect().left;
            original_y = element.getBoundingClientRect().top;
            original_mouse_x = e.pageX;
            original_mouse_y = e.pageY;
            
            window.addEventListener('mousemove', resize);
            window.addEventListener('mouseup', stopResize);
        });
        
        function resize(e) {
            const width = original_width + (e.pageX - original_mouse_x);
            const height = original_height + (e.pageY - original_mouse_y);
            
            if (width > 20) {
                element.style.width = width + 'px';
            }
            
            if (height > 20) {
                element.style.height = height + 'px';
            }
        }
        
        function stopResize() {
            window.removeEventListener('mousemove', resize);
        }
    }
    
    // Apply resizing to shapes added to the editor
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.classList.contains('shape') && !node.classList.contains('sticker')) {
                        makeElementResizable(node);
                    }
                });
            }
        });
    });
    
    observer.observe(editorArea, { childList: true });
    
    // Load html2canvas library
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector(`script[src="${src}"]`)) {
                resolve();
                return;
            }
            
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
    
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js')
        .then(() => console.log('html2canvas loaded'))
        .catch(error => console.error('Failed to load html2canvas:', error));
    
    // Add right-click context menu for elements
    editorArea.addEventListener('contextmenu', function(e) {
        if (e.target.classList.contains('text-box') || e.target.classList.contains('shape')) {
            e.preventDefault();
            
            // Remove any existing context menus
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            selectedElement = e.target;
            
            // Create context menu
            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.position = 'absolute';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.style.backgroundColor = 'var(--navbar-color)';
            contextMenu.style.border = '1px solid rgba(255, 255, 255, 0.1)';
            contextMenu.style.borderRadius = '4px';
            contextMenu.style.padding = '5px 0';
            contextMenu.style.zIndex = '1000';
            
            // Menu options
            const options = [
                { text: 'Bring to Front', icon: 'fas fa-layer-group', action: bringToFront },
                { text: 'Send to Back', icon: 'fas fa-layer-group', action: sendToBack },
                { text: 'Duplicate', icon: 'fas fa-copy', action: duplicateElement },
                { text: 'Delete', icon: 'fas fa-trash', action: deleteElement }
            ];
            
            options.forEach(option => {
                const item = document.createElement('div');
                item.style.padding = '8px 12px';
                item.style.cursor = 'pointer';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.gap = '8px';
                item.style.color = 'var(--secondary-color)';
                
                item.innerHTML = `<i class="${option.icon}"></i> ${option.text}`;
                
                item.addEventListener('mouseenter', function() {
                    item.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
                
                item.addEventListener('mouseleave', function() {
                    item.style.backgroundColor = 'transparent';
                });
                
                item.addEventListener('click', function() {
                    option.action(selectedElement);
                    contextMenu.remove();
                });
                
                contextMenu.appendChild(item);
            });
            
            document.body.appendChild(contextMenu);
            
            // Close menu when clicking elsewhere
            function closeContextMenu(e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.remove();
                    document.removeEventListener('click', closeContextMenu);
                }
            }
            
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
            }, 10);
        }
    });
    
    // Element manipulations for context menu
    function bringToFront(element) {
        element.style.zIndex = '100';
    }
    
    function sendToBack(element) {
        element.style.zIndex = '1';
    }
    
    function duplicateElement(element) {
        const clone = element.cloneNode(true);
        
        // Offset the position slightly
        const offsetX = 20;
        const offsetY = 20;
        
        if (element.style.left && element.style.top) {
            const left = parseInt(element.style.left) + offsetX;
            const top = parseInt(element.style.top) + offsetY;
            clone.style.left = left + 'px';
            clone.style.top = top + 'px';
        }
        
        editorArea.appendChild(clone);
        makeElementDraggable(clone);
        
        if (clone.classList.contains('shape') && !clone.classList.contains('sticker')) {
            makeElementResizable(clone);
        }
    }
    
    function deleteElement(element) {
        element.remove();
        selectedElement = null;
    }
    
    // Add a CSS rule for selected elements
    const style = document.createElement('style');
    style.textContent = `
        .text-box.selected, .shape.selected {
            outline: 2px dashed var(--primary-color);
            outline-offset: 2px;
        }
    `;
    document.head.appendChild(style);

    // Add mobile toolbar button active state handling
    const toolButtons = document.querySelectorAll('.tool-button');
    toolButtons.forEach(button => {
        button.addEventListener('click', function() {
            toolButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        });
    });
});
        </script>
    </body>
</html>