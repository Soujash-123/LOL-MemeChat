<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Text Editor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Import fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');

        :root {
            --primary-color: #60a5fa;
            --secondary-color: #e2e8f0;
            --background-color: #0f172a;
            --navbar-color: rgba(15, 23, 42, 0.95);
            --font-family: 'Inter';
        }

        body {
            font-family: var(--font-family), sans-serif;
            background: var(--background-color);
            color: var(--secondary-color);
        }

        .glass-effect {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vertical-nav {
            width: 240px;
            height: 100vh;
            position: fixed;
            left: -240px;
            top: 0;
            background: var(--navbar-color);
            backdrop-filter: blur(10px);
            z-index: 50;
            transition: left 0.3s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vertical-nav.open {
            left: 0;
        }

        .burger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 60;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            background: var(--navbar-color);
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .burger-menu span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--secondary-color);
            transition: all 0.3s ease;
        }

        .burger-menu.open span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .burger-menu.open span:nth-child(2) {
            opacity: 0;
        }

        .burger-menu.open span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--secondary-color);
        }

        .nav-link:hover {
            color: var(--primary-color);
            background: rgba(96, 165, 250, 0.1);
        }

        .nav-link.active {
            color: var(--primary-color);
            background: rgba(96, 165, 250, 0.1);
            border-right: 3px solid var(--primary-color);
        }

        .main-content {
            margin-left: 0;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            padding: 2rem;
            padding-top: 6rem;
            background: radial-gradient(circle at center, rgba(96, 165, 250, 0.1), transparent);
        }

        .theme-button {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-button:hover {
            transform: rotate(30deg);
        }

        .theme-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .theme-modal.active {
            display: flex;
        }

        .theme-content {
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
        }

        @media (min-width: 768px) {
            .vertical-nav {
                left: 0;
            }

            .burger-menu {
                display: none;
            }

            .main-content {
                margin-left: 240px;
            }

            .theme-button {
                right: 40px;
            }
        }

        .gradient-button {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            transition: all 0.3s ease;
        }

        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(96, 165, 250, 0.3);
        }

        textarea {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.95);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            background-color: rgba(30, 41, 59, 0.8);
            border-radius: 6px;
        }

        .control-group {
            margin-right: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #3367d6;
        }

        .editor-area {
            position: relative;
            border: 2px dashed var(--primary-color);
            min-height: 400px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        #imageCanvas {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        .text-box {
            position: absolute;
            min-width: 50px;
            min-height: 20px;
            padding: 5px;
            border: 1px dashed var(--primary-color);
            cursor: move;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .text-box:focus {
            outline: none;
            border: 1px solid var(--primary-color);
        }

        .instructions {
            background-color: rgba(232, 245, 233, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .instructions ul {
            margin-bottom: 0;
            color: var(--secondary-color);
        }

        /* Template gallery styles */
        .template-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 120px;
        }

        .template-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        .template-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .template-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            font-size: 12px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .template-item:hover .overlay {
            opacity: 1;
        }

        .tab-controls {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--secondary-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .sticker-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .sticker-item {
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .sticker-item:hover {
            transform: scale(1.1);
        }

        .sticker {
            position: absolute;
            cursor: move;
            width: 80px;
            height: 80px;
        }

        .sticker img {
            width: 100%;
            height: 100%;
        }

        .delete-button {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: red;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .sticker:hover .delete-button {
            display: flex;
        }

        .text-box:hover .delete-button {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="burger-menu">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <nav class="vertical-nav">
        <div class="py-6 px-4">
            <h1 class="text-2xl font-bold text-center">
                L<span style="color: var(--primary-color)">❤</span>L
            </h1>
        </div>
        
        <div class="space-y-2">
            <a href="/feed" class="nav-link">
                <i class="fas fa-compass"></i>
                <span>Explore</span>
            </a>
            <a href="/dashboard" class="nav-link">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/chat" class="nav-link">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </a>
            <a href="/create" class="nav-link">
                <i class="fas fa-plus"></i>
                <span>Create</span>
            </a>
            <a href="/moodboard" class="nav-link active">
                <i class="fas fa-plus"></i>
                <span>Moodboard</span>
            </a>
            <a href="/list_connect" class="nav-link">
                <i class="fas fa-users"></i>
                <span>Matches</span>
            </a>
            <a href="/music-feed" class="nav-link">
                <i class="fas fa-headphones"></i>
                <span>My Music</span>
            </a>
            <a href="#" class="nav-link" onclick="navigateToProfile(event)">
                <i class="fas fa-user"></i><span>Profile</span>
            </a>
            <a href="#" onclick="logout()" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <h1>Moodboard Creator</h1>
            
            <div class="instructions">
                <h3>How to Use:</h3>
                <ul>
                    <li>Select a template or upload your own image</li>
                    <li>Add text boxes and stickers to customize your moodboard</li>
                    <li>Drag elements to position them anywhere on the image</li>
                    <li>When finished, download your creation</li>
                </ul>
            </div>

            <div class="tab-controls">
                <button class="tab-button active" data-tab="templates">Templates</button>
                <button class="tab-button" data-tab="upload">Upload Image</button>
                <button class="tab-button" data-tab="customize">Customize</button>
            </div>
            
            <div id="templates-tab" class="tab-content active">
                <h3 class="mb-4">Choose a Template</h3>
                <div class="template-gallery">
                    <div class="template-item" data-template="template-nature">
                        <img src="/api/placeholder/200/120" alt="Nature Template">
                        <div class="overlay">Nature</div>
                    </div>
                    <div class="template-item" data-template="template-love">
                        <img src="/api/placeholder/200/120" alt="Love Template">
                        <div class="overlay">Love</div>
                    </div>
                    <div class="template-item" data-template="template-urban">
                        <img src="/api/placeholder/200/120" alt="Urban Template">
                        <div class="overlay">Urban</div>
                    </div>
                    <div class="template-item" data-template="template-adventure">
                        <img src="/api/placeholder/200/120" alt="Adventure Template">
                        <div class="overlay">Adventure</div>
                    </div>
                    <div class="template-item" data-template="template-music">
                        <img src="/api/placeholder/200/120" alt="Music Template">
                        <div class="overlay">Music</div>
                    </div>
                    <div class="template-item" data-template="template-food">
                        <img src="/api/placeholder/200/120" alt="Food Template">
                        <div class="overlay">Food</div>
                    </div>
                    <div class="template-item" data-template="template-travel">
                        <img src="/api/placeholder/200/120" alt="Travel Template">
                        <div class="overlay">Travel</div>
                    </div>
                    <div class="template-item" data-template="template-minimal">
                        <img src="/api/placeholder/200/120" alt="Minimal Template">
                        <div class="overlay">Minimal</div>
                    </div>
                </div>
            </div>
            
            <div id="upload-tab" class="tab-content">
                <div class="control-group">
                    <label for="imageUpload">Upload Your Own Image:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
            </div>

            <div id="customize-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label for="addTextBtn">Text:</label>
                        <button id="addTextBtn">Add Text Box</button>
                    </div>
                    
                    <div class="control-group">
                        <label for="fontFamily">Font Family:</label>
                        <select id="fontFamily">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Impact, fantasy">Impact</option>
                            <option value="'Dancing Script', cursive">Dancing Script</option>
                            <option value="'Pacifico', cursive">Pacifico</option>
                            <option value="'Playfair Display', serif">Playfair Display</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Great Vibes', cursive">Great Vibes</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="fontSize">Font Size:</label>
                        <input type="number" id="fontSize" min="8" max="72" value="16">
                    </div>
                    
                    <div class="control-group">
                        <label for="fontColor">Font Color:</label>
                        <input type="color" id="fontColor" value="#000000">
                    </div>
                    
                    <div class="control-group">
                        <label for="fontBold">Bold:</label>
                        <input type="checkbox" id="fontBold">
                    </div>
                    
                    <div class="control-group">
                        <label for="fontItalic">Italic:</label>
                        <input type="checkbox" id="fontItalic">
                    </div>
                    
                    <div class="control-group">
                        <label for="backgroundColor">Background:</label>
                        <input type="color" id="backgroundColor" value="#ffffff">
                    </div>
                    
                    <div class="control-group">
                        <label for="backgroundOpacity">Opacity:</label>
                        <input type="range" id="backgroundOpacity" min="0" max="1" step="0.1" value="0.7">
                    </div>
                </div>

                <h3 class="mb-4">Stickers</h3>
                <div class="sticker-gallery">
                    <div class="sticker-item" data-sticker="emoji-heart">
                        <img src="/api/placeholder/60/60" alt="Heart Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-star">
                        <img src="/api/placeholder/60/60" alt="Star Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-smile">
                        <img src="/api/placeholder/60/60" alt="Smile Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-fire">
                        <img src="/api/placeholder/60/60" alt="Fire Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-music">
                        <img src="/api/placeholder/60/60" alt="Music Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-travel">
                        <img src="/api/placeholder/60/60" alt="Travel Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-food">
                        <img src="/api/placeholder/60/60" alt="Food Emoji">
                    </div>
                    <div class="sticker-item" data-sticker="emoji-love">
                        <img src="/api/placeholder/60/60" alt="Love Emoji">
                    </div>
                </div>
            </div>
            
            <div class="editor-area" id="editorArea">
                <canvas id="imageCanvas"></canvas>
            </div>
            
            <div class="text-center mb-4">
                <button id="downloadBtn" class="gradient-button">
                    <i class="fas fa-download mr-2"></i> Download Moodboard
                </button>
            </div>
        </div>
    </main>

    <button class="theme-button">
        <i class="fas fa-paint-brush"></i>
    </button>

    <!-- Theme Modal -->
    <div class="theme-modal">
        <div class="theme-content glass-effect">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Customize Theme</h3>
                <button class="close-theme text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block mb-2">Primary Color</label>
                    <input type="color" id="primary-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Secondary Color</label>
                    <input type="color" id="secondary-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Background Color</label>
                    <input type="color" id="background-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Navbar Color</label>
                    <input type="color" id="navbar-color" class="w-full h-10 rounded">
                </div>
                <div>
                    <label class="block mb-2">Font Family</label>
                    <select id="font-family" class="w-full p-2 rounded bg-gray-800 text-white">
                        <optgroup label="Sans Serif">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Lato">Lato</option>
                            <option value="Montserrat">Montserrat</option>
                        </optgroup>
                        <optgroup label="Serif">
                            <option value="Playfair Display">Playfair Display</option>
                        </optgroup>
                        <optgroup label="Cursive">
                            <option value="Dancing Script">Dancing Script</option>
                            <option value="Pacifico">Pacifico</option>
                            <option value="Great Vibes">Great Vibes</option>
                        </optgroup>
                    </select>
                </div>
                <button class="w-full py-2 px-4 gradient-button text-white rounded" id="reset-theme">
                    Reset to Default
                </button>
            </div>
        </div>
    </div>

    <script>
        async function navigateToProfile(event) {
            event.preventDefault();
            try {
                const response = await fetch('/user/profile');
                if (!response.ok) throw new Error('Failed to fetch profile');
                const data = await response.json();
                window.location.href = `/${data.username}`;
            } catch (error) {
                console.error('Error navigating to profile:', error);
            }
        }

        const themeKeys = {
            primaryColor: '--primary-color',
            secondaryColor: '--secondary-color',
            backgroundColor: '--background-color',
            navbarColor: '--navbar-color',
            fontFamily: '--font-family',
        };

        function initializeTheme() {
            Object.keys(themeKeys).forEach(key => {
                const savedValue = localStorage.getItem(key);
                if (savedValue) {
                    document.documentElement.style.setProperty(themeKeys[key], savedValue);
                    const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) {
                        input.value = savedValue;
                    }
                }
            });
        }

        function setupThemeListeners() {
            document.querySelector('.theme-button').addEventListener('click', () => {
                document.querySelector('.theme-modal').classList.add('active');
            });

            document.querySelector('.close-theme').addEventListener('click', () => {
                document.querySelector('.theme-modal').classList.remove('active');
            });

            document.querySelector('.theme-modal').addEventListener('click', (e) => {
                if (e.target === document.querySelector('.theme-modal')) {
                    document.querySelector('.theme-modal').classList.remove('active');
                }
            });

            Object.keys(themeKeys).forEach(key => {
                const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (input) {
                    input.addEventListener('input', (e) => {
                        document.documentElement.style.setProperty(themeKeys[key], e.target.value);
                        localStorage.setItem(key, e.target.value);
                    });
                }
            });

            document.getElementById('reset-theme').addEventListener('click', () => {
                const defaults = {
                    primaryColor: '#60a5fa',
                    secondaryColor: '#e2e8f0',
                    backgroundColor: '#0f172a',
                    navbarColor: 'rgba(15, 23, 42, 0.95)',
                    fontFamily: 'Inter'
                };
                
                Object.entries(defaults).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(themeKeys[key], value);
                    localStorage.setItem(key, value);
                    
                    const input = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (input) {
                        if (input.type === 'color') {
                            if (value.startsWith('rgba')) {
                                const rgb = value.match(/\d+/g).slice(0, 3);
                                const hex = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                                input.value = hex;
                            } else {
                                input.value = value;
                            }
                        } else {
                            input.value = value;
                        }
                    }
                });
            });
        }

        // Navigation functionality 
        const burgerMenu = document.querySelector('.burger-menu');
        const nav = document.querySelector('.vertical-nav');

        burgerMenu.addEventListener('click', () => {
            burgerMenu.classList.toggle('open');
            nav.classList.toggle('open');
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                burgerMenu.classList.remove('open');
                nav.classList.remove('open');
            }
        });

        async function logout() {
            try {
                const response = await fetch('/logout');
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    alert('Failed to logout');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Failed to logout');
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            setupThemeListeners();
            initMoodboardEditor();
        });

        // Moodboard Editor Script
        // Moodboard Editor Script
function initMoodboardEditor() {
    const imageUpload = document.getElementById('imageUpload');
    const imageCanvas = document.getElementById('imageCanvas');
    const editorArea = document.getElementById('editorArea');
    const addTextBtn = document.getElementById('addTextBtn');
    const fontFamily = document.getElementById('fontFamily');
    const fontSize = document.getElementById('fontSize');
    const fontColor = document.getElementById('fontColor');
    const fontBold = document.getElementById('fontBold');
    const fontItalic = document.getElementById('fontItalic');
    const backgroundColor = document.getElementById('backgroundColor');
    const backgroundOpacity = document.getElementById('backgroundOpacity');
    const downloadBtn = document.getElementById('downloadBtn');
    
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const templateItems = document.querySelectorAll('.template-item');
    const stickerItems = document.querySelectorAll('.sticker-item');
    
    let activeElement = null;
    let currentImage = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    
    // Tab functionality
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        });
    });
    
    // Image upload handler
    imageUpload.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                loadImageToCanvas(event.target.result);
            }
            
            reader.readAsDataURL(e.target.files[0]);
        }
    });
    
    // Template selection handler
    templateItems.forEach(item => {
        item.addEventListener('click', () => {
            // In a real app, these would be actual image paths
            // For this example, we'll use placeholder
            const templateName = item.getAttribute('data-template');
            // This would load the actual template image
            loadImageToCanvas(`/api/placeholder/800/600?text=${templateName}`);
            
            // Switch to customize tab after selecting a template
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="customize"]').classList.add('active');
            document.getElementById('customize-tab').classList.add('active');
        });
    });
    
    // Load image to canvas
    function loadImageToCanvas(src) {
        const img = new Image();
        img.onload = function() {
            // Set canvas dimensions to match image
            const maxWidth = editorArea.clientWidth;
            let width = img.width;
            let height = img.height;
            
            // Scale image if it's too large
            if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
            }
            
            imageCanvas.width = width;
            imageCanvas.height = height;
            
            const ctx = imageCanvas.getContext('2d');
            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            
            currentImage = img;
        };
        img.src = src;
    }
    
    // Add text box functionality
    addTextBtn.addEventListener('click', () => {
        const textBox = document.createElement('div');
        textBox.className = 'text-box';
        textBox.contentEditable = true;
        textBox.innerHTML = 'Add your text here';
        
        // Apply current text styles
        applyCurrentTextStyles(textBox);
        
        // Add delete button
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-button';
        deleteBtn.innerHTML = 'x';
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            textBox.remove();
        });
        textBox.appendChild(deleteBtn);
        
        // Position in the center of the editor area
        textBox.style.left = (editorArea.clientWidth / 2 - 100) + 'px';
        textBox.style.top = (editorArea.clientHeight / 2 - 20) + 'px';
        
        editorArea.appendChild(textBox);
        makeElementDraggable(textBox);
        textBox.focus();
    });
    
    // Apply text styles to a text box
    function applyCurrentTextStyles(element) {
        element.style.fontFamily = fontFamily.value;
        element.style.fontSize = fontSize.value + 'px';
        element.style.color = fontColor.value;
        element.style.fontWeight = fontBold.checked ? 'bold' : 'normal';
        element.style.fontStyle = fontItalic.checked ? 'italic' : 'normal';
        
        // Convert hex to rgba for background
        const hex = backgroundColor.value;
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const a = backgroundOpacity.value;
        
        element.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${a})`;
    }
    
    // Update text styles on change
    [fontFamily, fontSize, fontColor, fontBold, fontItalic, backgroundColor, backgroundOpacity].forEach(control => {
        control.addEventListener('input', () => {
            if (activeElement && activeElement.classList.contains('text-box')) {
                applyCurrentTextStyles(activeElement);
            }
        });
    });
    
    // Handle sticker clicks
    stickerItems.forEach(item => {
        item.addEventListener('click', () => {
            const stickerName = item.getAttribute('data-sticker');
            addSticker(stickerName);
        });
    });
    
    // Add a sticker to the editor
    function addSticker(stickerName) {
        const sticker = document.createElement('div');
        sticker.className = 'sticker';
        
        // Create image element
        const img = document.createElement('img');
        img.src = `/api/placeholder/80/80?text=${stickerName}`;
        img.alt = stickerName;
        
        // Add delete button
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-button';
        deleteBtn.innerHTML = 'x';
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sticker.remove();
        });
        
        sticker.appendChild(img);
        sticker.appendChild(deleteBtn);
        
        // Position in the center of the editor area
        sticker.style.left = (editorArea.clientWidth / 2 - 40) + 'px';
        sticker.style.top = (editorArea.clientHeight / 2 - 40) + 'px';
        
        editorArea.appendChild(sticker);
        makeElementDraggable(sticker);
    }
    
    // Make an element draggable
    function makeElementDraggable(element) {
        element.addEventListener('mousedown', startDrag);
        element.addEventListener('touchstart', startDrag, { passive: false });
        
        // Mark this element as active when clicked
        element.addEventListener('click', () => {
            if (activeElement) {
                activeElement.classList.remove('active-element');
            }
            activeElement = element;
            element.classList.add('active-element');
        });
    }
    
    function startDrag(e) {
        e.preventDefault();
        
        // Set the current element as active
        if (activeElement) {
            activeElement.classList.remove('active-element');
        }
        activeElement = this;
        this.classList.add('active-element');
        
        // Get initial position
        const rect = this.getBoundingClientRect();
        
        // Calculate offset for drag
        if (e.type === 'touchstart') {
            dragOffsetX = e.touches[0].clientX - rect.left;
            dragOffsetY = e.touches[0].clientY - rect.top;
        } else {
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
        }
        
        // Add move and end event listeners
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }
    
    function drag(e) {
        e.preventDefault();
        if (!activeElement) return;
        
        let clientX, clientY;
        
        if (e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        // Calculate new position
        const editorRect = editorArea.getBoundingClientRect();
        let left = clientX - editorRect.left - dragOffsetX;
        let top = clientY - editorRect.top - dragOffsetY;
        
        // Constrain to editor area
        const elementWidth = activeElement.offsetWidth;
        const elementHeight = activeElement.offsetHeight;
        
        if (left < 0) left = 0;
        if (top < 0) top = 0;
        if (left + elementWidth > editorRect.width) left = editorRect.width - elementWidth;
        if (top + elementHeight > editorRect.height) top = editorRect.height - elementHeight;
        
        // Set new position
        activeElement.style.left = left + 'px';
        activeElement.style.top = top + 'px';
    }
    
    function endDrag() {
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);
    }
    
    // Download functionality
    downloadBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas dimensions to match editor
        canvas.width = imageCanvas.width;
        canvas.height = imageCanvas.height;
        
        // Draw background image
        if (currentImage) {
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
        } else {
            // Fill with white if no image
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Draw text boxes and stickers
        const elements = Array.from(editorArea.querySelectorAll('.text-box, .sticker'));
        
        elements.forEach(el => {
            if (el.classList.contains('text-box')) {
                // Draw text
                const styles = window.getComputedStyle(el);
                
                ctx.font = `${styles.fontStyle} ${styles.fontWeight} ${styles.fontSize} ${styles.fontFamily}`;
                ctx.fillStyle = styles.backgroundColor;
                
                const x = parseFloat(el.style.left);
                const y = parseFloat(el.style.top);
                const width = el.offsetWidth;
                const height = el.offsetHeight;
                
                // Draw background
                ctx.fillRect(x, y, width, height);
                
                // Draw text
                ctx.fillStyle = styles.color;
                ctx.textBaseline = 'top';
                const padding = 5; // Same as CSS padding
                const lines = el.innerText.split('\n');
                
                let lineHeight = parseInt(styles.fontSize) * 1.2;
                lines.forEach((line, i) => {
                    ctx.fillText(line, x + padding, y + padding + i * lineHeight);
                });
            } else if (el.classList.contains('sticker')) {
                // Draw sticker
                const img = el.querySelector('img');
                const x = parseFloat(el.style.left);
                const y = parseFloat(el.style.top);
                const width = el.offsetWidth;
                const height = el.offsetHeight;
                
                ctx.drawImage(img, x, y, width, height);
            }
        });
        
        // Create download link
        const link = document.createElement('a');
        link.download = 'moodboard.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
    
    // Initialize with a default template
    loadImageToCanvas('/api/placeholder/800/600?text=Choose-a-template-or-upload-image');
}
</script>
</body>
</html>